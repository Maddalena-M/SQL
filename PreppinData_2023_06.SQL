WITH UNPIVOT_TABLE AS (SELECT CUSTOMER_ID, RATING,
split_part(CATEGORY, '___', 1) AS PLATFORM,
split_part(CATEGORY, '___', 2) AS QUESTION
FROM   
   (SELECT * FROM PD2023_WK06_DSB_CUSTOMER_SURVEY as Survey) 
UNPIVOT  
   (RATING FOR CATEGORY IN   
      (MOBILE_APP___EASE_OF_USE,
      MOBILE_APP___EASE_OF_ACCESS,
      MOBILE_APP___LIKELIHOOD_TO_RECOMMEND,
      ONLINE_INTERFACE___EASE_OF_USE,
      ONLINE_INTERFACE___EASE_OF_ACCESS,
      ONLINE_INTERFACE___LIKELIHOOD_TO_RECOMMEND)  
)
), REPIVOT AS(SELECT 
    CUSTOMER_ID,
    AVG("'MOBILE_APP'") AS MOBILE_APP_SCORE,
    AVG("'ONLINE_INTERFACE'") AS ONLINE_INTERFACE_SCORE, 
    MOBILE_APP_SCORE-ONLINE_INTERFACE_SCORE AS DIFF, 
    CASE
        WHEN DIFF>=2 THEN 'MOBILE_APP_SUPERFAN'
        WHEN DIFF>=1 THEN 'MOBILE_APP_FAN'
        WHEN DIFF<=-2 THEN 'ONLINE_INTERFACE_SUPERFAN'
        WHEN DIFF<=-1 THEN 'ONLINE_INTERFACE-FAN'
        ELSE 'NEUTRAL'
    END AS PREFERENCE
        
    FROM UNPIVOT_TABLE
    PIVOT (SUM(RATING) FOR PLATFORM IN ('MOBILE_APP', 'ONLINE_INTERFACE'))
    AS PVT GROUP BY CUSTOMER_ID
), 
TOTAL AS (SELECT COUNT(PREFERENCE) AS TOTAL_PREF FROM REPIVOT)

SELECT PREFERENCE, COUNT(PREFERENCE)/MIN(TOTAL_PREF) FROM REPIVOT JOIN TOTAL ON 1=1 GROUP BY PREFERENCE